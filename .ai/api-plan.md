# REST API Plan

## 1. Resources

- **Users**: Represents the users in the system. Mapped to the `users` table with fields such as `id`, `email`, `encrypted_password`, `created_at`, and `confirmed_at`.
- **Generations**: Represents flashcard generation requests. Mapped to the `generations` table with fields including `id`, `user_id`, `model`, `generated_count`, `accepted_unedited_count`, `accepted_edited_count`, `source_text_hash`, `source_text_length`, `generation_duration`, `created_at`, and `updated_at`. It links to a user via `user_id`.
- **Flashcards**: Represents individual flashcards. Mapped to the `flashcards` table with fields like `id`, `front`, `back`, `source`, `created_at`, `updated_at`, `generation_id`, and `user_id`. Each flashcard can optionally relate to a generation.
- **GenerationErrorLogs**: Represents error log entries from failed generation attempts. Mapped to the `generation_error_logs` table with fields including `id`, `user_id`, `model`, `source_text_hash`, `source_text_length`, `error_code`, `error_message`, and `created_at`.

## 2. Endpoints

### Generations Endpoints

- **POST /api/generations**

  - **Description**: Calls the AI service to generate flashcard proposals. Validates the input text length (between 1000 and 10000 characters).
  - **Request Payload**:
    ```json
    {
      "source_text": "User provided text (1000 to 10000 characters)"
    }
    ```
  - **Response**:
    ```json
    {
      "id": "number",
      "flashcards_proposals": [
        { "id": 1, "front": "Generated question", "back": "Generated answer", "source": "ai-full" }
      ],
      "generated_count": "number",
      "created_at": "timestamp"
    }
    ```
  - **Success Codes**: 201 Created
  - **Error Codes**: 400 Bad Request, 401 Unauthorized, 500: AI service errors (logs recorder in `generation_error_logs`)

- **GET /api/generations**

  - **Description**: Retrieves a paginated list of generation requests for the authenticated user.
  - **Query Parameters**: `page`, `limit`
  - **Response**: Paginated list of generations.
  - **Success Codes**: 200 OK
  - **Error Codes**: 401 Unauthorized

- **GET /api/generations/{id}**
  - **Description**: Retrieves details of a specific generation, including associated flashcard proposals.
  - **Response**: Detailed generation record.
  - **Success Codes**: 200 OK
  - **Error Codes**: 401 Unauthorized, 404 Not Found

### Flashcards Endpoints

- **GET /api/flashcards**

  - **Description**: Retrieves a paginated list of flashcards for the authenticated user, with options for filtering and sorting.
  - **Query Parameters**: `page`, `limit`, `sort`, `filter`
  - **Response**: Containing a list of flashcards.
  - **Success Codes**: 200 OK
  - **Error Codes**: 401 Unauthorized

- **POST /api/flashcards**

  - **Description**: Creates one or multiple flashcards, supporting both manual creation and AI-generated cards.
  - **Request Payload**:
    ```json
    {
      "flashcards": [
        {
          "front": "string",
          "back": "string",
          "source": "manual", // allowed values: "ai-full", "ai-edited", "manual"
          "generation_id": "string | null" // required for AI-generated cards
        }
      ]
    }
    ```
  - **Response**: Array of created flashcard records.
  - **Success Codes**: 201 Created
  - **Error Codes**: 400 Bad Request, 401 Unauthorized
  - **Validations**:
    - `front`: Required, non-empty string, max length: 200 characters.
    - `back`: Required, non-empty string, max length: 500 characters.
    - `source`: Required, must be one of: "ai-full", "ai-edited", "manual"
    - `generation_id`:
      - Must be null when source is "manual"
      - Required and must be a valid generation ID when source is "ai-full" or "ai-edited"

- **GET /api/flashcards/{id}**

  - **Description**: Retrieves details of a specific flashcard.
  - **Response**: Flashcard record in detail.
  - **Success Codes**: 200 OK
  - **Error Codes**: 401 Unauthorized, 404 Not Found

- **PUT /api/flashcards/{id}**

  - **Description**: Updates a flashcard's details. This endpoint supports editing flashcards generated by AI (e.g., changing source from "ai-full" to "ai-edited") or manually created flashcards.
  - **Request Payload**:
    ```json
    {
      "front": "string",
      "back": "string",
      "source": "string" // allowed updates as per business rules
    }
    ```
  - **Response**: Updated flashcard record.
  - **Success Codes**: 200 OK
  - **Error Codes**: 400 Bad Request, 401 Unauthorized, 404 Not Found
  - **Validations**:
    - `front`: Required, non-empty string, max length: 200 characters.
    - `back`: Required, non-empty string, max length: 500 characters.
    - `source`: Required, must be one of: "ai-full", "ai-edited", "manual"

- **DELETE /api/flashcards/{id}**
  - **Description**: Deletes a flashcard.
  - **Response**:
    ```json
    { "message": "Flashcard deleted successfully." }
    ```
  - **Success Codes**: 200 OK
  - **Error Codes**: 401 Unauthorized, 404 Not Found

### Generation Error Logs Endpoints

- **GET /api/generation-error-logs**
  - **Description**: Retrieves a paginated list of generation error logs for the authenticated user.
  - **Response**: List of error log records.
  - **Success Codes**: 200 OK
  - **Error Codes**: 401 Unauthorized

## 3. Authentication and Authorization

- **Mechanism**: Token-based authentication using Supabase Auth.
- **Implementation**:
  - Users authenticate via `/auth/login` or `/auth/register`, receiving a bearer token.
  - All other endpoints require an Authorization header with a valid token.
  - Database-level Row-level security (RLS) ensures that users access only records matching their `user_id`.
- **Additional Security Measures**:
  - use HTTPS, rate limiting, and secure error messaging to mitigate security risks.
  - Rate limiting on sensitive endpoints (e.g., flashcard generation) to prevent abuse.

## 4. Validation and Business Logic

- **Input Validation**:
  - **Generations**: The `text` field must be between 1000 and 10000 characters, as enforced by the database schema.
  - **Flashcards**: The `source` field must be one of `ai-full`, `ai-edited`, or `manual`.
- **Business Logic**:

  - **Automatic Flashcard Generation**: When a user submits text to `/api/generations`, the system calls the LLM API to generate flashcard proposals. The generated data is stored and associated flashcards are created.
  - **Flashcard Approval and Editing**: Users can review generated flashcards and update them via the PUT `/api/flashcards/{id}` endpoint. Approval may involve changing the flashcard's source from `ai-full` to `ai-edited`.
  - **Error Handling and Logging**: Any errors during the generation process are logged in the `generation_error_logs` table and can be retrieved by the user through the `/api/error-logs` endpoint.

- **Database Optimizations**:
  - Indexes on `user_id` in `flashcards`, `generations`, and `generation_error_logs` ensure efficient queries for authenticated users.
  - Foreign key constraints maintain data integrity between related resources.
